{% extends "layout.html" %}
{% block scripts %}
<script type=text/javascript>
  function refreshProgress() {
    $.getJSON($SCRIPT_ROOT + '/progress', {
        uservalue: $('input[name="uservalue"]').val(),
    }, function(data) {
        $("#prog").text(data.prog);
        
        for (i in data.jobs){
            job = data.jobs[i];
            document.getElementById(job.id+"_pbar").style.width = data.prog + "%";
            for (j in job.tasks){
                task = job.tasks[j];
                try{
                    document.getElementById(job.id+"_"+task.id+"_pbar").style.width = data.prog + "%";
                }
                catch (err){
                    
                }
            }
        }
    
    });
  };

    function jobClicked(event){
        var data = event.data.data
        var job_id = event.data.id

        // Clear previous tasks if any
        var myNode = document.getElementById("task_list")
        while (myNode.firstChild) {
            myNode.removeChild(myNode.firstChild);
        }

        for (i in data.jobs){
            document.getElementById("job_btn_"+data.jobs[i].id).style.border = "none";
        }

        document.getElementById("job_btn_"+job_id).style.border = "1px solid";
        document.getElementById("job_btn_"+job_id).style.borderColor = "#35bce3";
        document.getElementById("task_pane").style.display = "block";

        for (i in data.jobs){
            var job = data.jobs[i];

            if (job.id == event.data.id){
                for (j in job.tasks){
                    var task = job.tasks[j];

                    var taskRow = document.createElement('div');
                    taskRow.setAttribute('id', job.id+'_'+task.id+'_'+'_row');
                    taskRow.setAttribute('class','row text-left');
                    document.getElementById("task_list").appendChild(taskRow);

                        var taskNameCol1 = document.createElement('div');
                        taskNameCol1.setAttribute('class', 'col-sm-6');
                        taskRow.appendChild(taskNameCol1);

                            var taskNameSpan = document.createElement('span');
                            taskNameSpan.textContent = task.name;
                            taskNameSpan.setAttribute('style', 'font-size: 1.3em;');
                            taskNameCol1.appendChild(taskNameSpan);

                        var taskNameCol2 = document.createElement('div');
                        taskNameCol2.setAttribute('class', 'col-sm-6');
                        taskRow.appendChild(taskNameCol2);

                            var taskProgContainer = document.createElement('div');
                            taskProgContainer.setAttribute('class', 'progress progress-striped active');
                            taskNameCol2.appendChild(taskProgContainer);

                            var taskProgBar = document.createElement('div');
                            taskProgBar.setAttribute('id', job.id+'_'+task.id+'_pbar');
                            taskProgBar.setAttribute('class', 'progress-bar');
                            taskProgBar.setAttribute('role', 'progressbar');
                            taskProgBar.setAttribute('aria-valuenow','0');
                            taskProgBar.setAttribute('aria-valuemin','0');
                            taskProgBar.setAttribute('aria-valuemax','100');
                            taskProgBar.setAttribute('style','width: 0%');
                            taskProgContainer.appendChild(taskProgBar);
                }
                break;
            }
        }
    }


    function init(){
    window.setInterval(refreshProgress, 2000); // repeat forever, polling every second

        $.getJSON($SCRIPT_ROOT + '/progress', function(data) {
            for (i in data.jobs){
                var job = data.jobs[i];
                $( "#job_btn_"+job.id ).bind('click', {'id':job.id, 'data':data}, jobClicked);
            }
      });
    }

</script>
<link href="{{url_for( 'static', filename = 'css/jobs.css' )}}" rel="stylesheet">
{% endblock %}
{% block body %}
    <div class="row text-right">
        <div class="col-sm-3">
            <div class="row text-left bottom-buffer>"><div class="col-xs-4"><h1>Jobs</h1></div></div>
            {% for job in jobs %}
                <div id="job_btn_{{ job.id }}" class="pane-item">
                    <h2>{{ job.name }}</h2>
                    <div class="progress progress-striped active">
                      <div id="{{ job.id }}_pbar" class="progress-bar"  role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="task_pane" class="col-sm-3 col-xs-offset-1" style="display: none">
            <div class="row text-left>"><div class="col-xs-4"><h1>Tasks</h1></div></div>
            <br>
            <div id="task_list"></div>
            
        </div>
        <div id="details_pane" class="col-sm-3 col-xs-offset-1" style="display: none">
            <div class="row text-left>"><div class="col-xs-4"><h1>Details</h1></div></div>
            <br>
        </div>
    </div>
{% endblock %}